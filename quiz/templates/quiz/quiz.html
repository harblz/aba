{% extends 'base.html' %}

{% block quiz-content %}
  <span class="confetti_wrapper">

    <div class="progress">
      <div id="progress_bar_correct" class="progress-bar bg-success" role="progressbar" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100"></div>
      <div id="progress_bar_incorrect" class="progress-bar bg-danger" role="progressbar" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100"></div>
    </div>

    <!-- Displays the Quiz Results at the end !-->
    <div id="results"></div>

    <div id="question_text_wrapper">
    </div>


    <br>

    <div id="score_graph" class="fade" style="display: none; height: 100%; width: 100%;max-height: 400px; max-width: 400px;margin: 0 auto 0 auto;">
      <canvas id="myChart" width="400" height="400"></canvas>
    </div>

    <div class="container-fluid" id="score_graph_options" style="display:none;margin: 2.5rem auto 0 auto">
      <a href="." class="btn btn-info">Restart Quiz</a>
      <a href="/quiz" class="btn btn-success">Back to Quiz Menu</a>
      <a href="/study" class="btn btn-secondary">Back to Study Portal</a>
    </div>

    <div id="choice_menu_wrapper">
    </div>

    <div id="hint_wrapper">
    </div>

    <br /><br />
    <br /><br />
  </span>

  <div class="container" style="text-align: center;">
    <button type="button" data-toggle="collapse" href="#disqus_thread" class="btn btn-info">
      <i class="far fa-comment"></i>
      Toggle Comments
    </button>
  </div>

  <br /><br />

  <!-- Report Question as Erroneous Modal !-->
  <div class="modal fade" id="error_report_modal" tabindex="-1" role="dialog" aria-labelledby="error_report_modal" aria-hidden="true">
    <div class="modal-dialog" role="document">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="exampleModalLabel">Spot something fishy? &nbsp <i class="fas fa-fish"></i></h5>
          <button type="button" class="close" data-dismiss="modal" aria-label="Close">
            <span aria-hidden="true">&times;</span>
          </button>
        </div>
        <div class="modal-body">
          <br />
          <h5>See something wrong with this question?</h5>
          <p class="text-muted"><b>Thank you for your feedback!</b><br /> Report the type of error below, and I'll get an email prompting me to fix it from the server. Thank you in advance for your time and patience while I work to improve this site - and best of luck studying!</p>

        <form>
          <div class="form-group">
            <label for="error_type">What's wrong?</label>
            <select multiple class="form-control" id="error_type">
              <option>Glitch / Bug</option>
              <option>Typo / Spelling & Grammar</option>
              <option>Question / Choices are wrong (please describe below)</option>
              <option>This question / series is too difficult</option>
              <option>Other (please describe below)</option>
            </select>
          </div>
          <div class="form-group">
            <label for="exampleFormControlTextarea1">Please take a moment to summarize the problem:</label>
            <textarea class="form-control" id="error_description" rows="3"></textarea>
          </div>
        </form>

        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-dismiss="modal">Nevermind</button>
          <button type="button" class="btn btn-primary" onClick="submitReport()">Submit the report</button>
        </div>
      </div>
    </div>
  </div>

  <button type="button" id="error_modal_button" style="display: none;" class="btn btn-primary" data-toggle="modal" data-target="#error_modal">Oops - that's an error modal</button>

  <button type="button" id="report_modal_button" style="display: none;" class="btn btn-primary" data-toggle="modal" data-target="#error_report_modal">Report question modal</button>

  <!-- Disqus Code !-->
  <div id="disqus_thread" class="collapse col-12"></div>

  <!-- Incorrect Quiz Response Modal !-->
  <div id="error_modal_wrapper">
    <div id="error_modal" class="modal fade bd-example-modal-lg" tabindex="-1" role="dialog" aria-labelledby="Question Hint" aria-hidden="true">
      <div class="modal-dialog modal-lg">
        <button type="button" class="btn btn-primary font-weight-bold" style='cursor: pointer;width: 100%'; data-dismiss="modal">OK, I got it</button>
        <div class="modal-content">
          <div class="modal-header">
            <h4 class="modal-title alert alert-danger" style='width: 100%;'><b>Oops!</b> That answer was not correct</h4>
          </div>
          <div class="modal-body" style="font-size: 14px;">
            <div id="error_modal_message">

            </div>
          </body>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-primary font-weight-bold" style='cursor: pointer;width: 100%'; data-dismiss="modal">OK, I got it</button>
        </div>
      </div>
    </div>
  </div>

  <template id="question_text_template">
    <div id="question_template_text">
      <p class="mt-2" style="line-height: 2rem;">
        Question #<span id="questionNumber">1 </span> of <span id="template_question_max"></span> â€” <small>
          <span class="p-1 border-info rounded text-white bg-info font-weight-bold">
            <span id="template_question_form">Form</span>
          </span><br>
          <span class="p-1 border-info rounded text-white bg-primary font-weight-bold"><span id="template_unit_name"></span> Practice Quiz</span>
          &nbsp&nbsp <a class="text-warning font-weight-bold" data-toggle="modal" data-target="#error_report_modal" href="#"><i class="fas fa-flag"></i> Report Question </a>
          <br>
        </small>
      </p>

      <h6 style="font-size: 1.2rem;font-weight: normal;margin-top: 5px;">
        <span id="template_question_text"></span>
      </h6>
    </div>
  </template>

  <template id="hint_template">
    <div id="hint" class="collapse" style="margin: 25px;">
      <h3>Here's a hint:</h3>
      <span id="hint_template_text">Hint is still loading...</span>
    </div>
  </template>

  <!-- Choice Wrapper Template !-->
  <template id="choice_text_template">
    <div id="choice_menu" class="panel panel-primary">
      <div class="panel-heading">
        <h5 style="font-size: 1rem;font-weight: normal" class="font-italic panel-title">Select the best answer from these choices:</h5>
      </div>
      <div class="panel-body">
        <form id="choice_form" action="" method="POST" id="post-form">
        <!-- CSRF Token !-->
        <span id="csrf_token"></span>
        <div id="choices_wrapper">
          <!-- Options Template Goes Here !-->
        </div>
      </div>
      <div class="panel-footer">
        <div class="btn-group btn-group-justified" role="group" aria-label="...">
          <div class="btn-group" role="group">
            <button type="button" data-toggle="collapse" data-target="#hint" class="btn btn-default">Give me a hint!</button>
          </div>
          <div class="btn-group" role="group">
            <button type="submit" id="post-form" onClick="grade_question()" class="btn btn-info"><b>Submit Answer</b></button>
            </form>
          </div>
        </div>
      </div>
    </div>
  </template>

  <!-- Option Template !-->
  <template id="choice_template">
    <label class="quiz-choice-labels">
      <table id="table-choices" style="table-layout: fixed;width:100%;">
        <tr style="width:100%;display:table-row;border-radius: 15px;">
          <td style="vertical-align: top;width:15px;">
            <input type="radio" class="question_choice" name="choice" id="choice_template_input" is_correct="false" />
          </td>
          <td>
            <span id="choice_template_text" class="quiz-choice-labels" style="font-weight: normal"></span>
          </td>
        </tr>
      </table>
    </label>
    <br />
  </template>

  <script>

  /**
  *  RECOMMENDED CONFIGURATION VARIABLES: EDIT AND UNCOMMENT THE SECTION BELOW TO INSERT DYNAMIC VALUES FROM YOUR PLATFORM OR CMS.
  *  LEARN WHY DEFINING THESE VARIABLES IS IMPORTANT: https://disqus.com/admin/universalcode/#configuration-variables*/
  var disqus_config = function () {
      this.page.url = '{{ request.build_absolute_uri }}{{ object.get_absolute_url }}';
      this.page.identifier = '{{ unit_id }}';
      this.page.title = '{{ unit_name }} Practice Quiz';
  };

  function highlightAnswers() {
    $('#table-choices tr').on('click', function() {
        $('#table-choices tr').each(function(){
            $(this).css('backgroundColor','white');
        })
        $(this).css('backgroundColor','#17a2b8');
    }); 
  }

  highlightAnswers();

  
  (function() { // DON'T EDIT BELOW THIS LINE
    var d = document, s = d.createElement('script');
    s.src = 'https://https-aba-rocks.disqus.com/embed.js';
    s.setAttribute('data-timestamp', +new Date());
    (d.head || d.body).appendChild(s);
    })();
  </script>
  <noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>




<script>
  var dataset = [];

  // Score Pie Chart (generates a visualization of their score for the user)
  var ctx = document.getElementById("myChart");
  var myChart = new Chart(ctx, {
      type: 'doughnut',
      data: {
          labels: ["Incorrect", "Correct"],
          datasets: [{
              label: 'Score Report',
              data: dataset,
              backgroundColor: [
                  'rgba(255, 99, 132, 1)',
                  'rgba(75, 192, 192, 1)',
              ],
              borderColor: [
                  'rgba(255,99,132,1)',
                  'rgba(75, 192, 192, 1)',
              ],
              borderWidth: 1
          }]
      },
      options: {
          scales: {
              yAxes: [{
                  ticks: {
                      beginAtZero:true
                  }
              }]
          }
      }
  });

  $('#post-form').on('submit', function(event){
      event.preventDefault();
      grade_question();
  });

  var csrftoken = jQuery("[name=csrfmiddlewaretoken]").val();
  function csrfSafeMethod(method) {
      return (/^(GET|HEAD|OPTIONS|TRACE)$/.test(method));
  }
  $.ajaxSetup({
      beforeSend: function(xhr, settings) {
          if (!csrfSafeMethod(settings.type) && !this.crossDomain) {
              xhr.setRequestHeader("X-CSRFToken", csrftoken);
          }
      }
  });

  var current_score = [];

  var unit_id = "{{unit_id}}";
  localStorage.setItem("{{unit_id}}",JSON.stringify(current_score));

  var max_questions = Number("{{total_questions}}");
 
  function calculateScore() {
    var score = JSON.parse(localStorage.getItem("{{unit_id}}"));

    var incorrect_count = 0;
    var correct_count   = 0;
    for (i = 0; i < score.length; i++ ) {
      if ( score[i] == "correct" ) {
        correct_count++;
      } else {
        incorrect_count++;
      }
    }
    var total_score = correct_count/(incorrect_count+correct_count);

    var score = new Object();
    score.correct = correct_count;
    score.incorrect = incorrect_count;
    score.percent_correct = total_score;
    score.max_questions = Number(max_questions);

    $('#progress_bar_correct').css('width', (score.correct/score.max_questions*100)+'%').attr('aria-valuenow', (score.correct/score.max_questions*100));
    $('#progress_bar_incorrect').css('width', (score.incorrect/score.max_questions*100)+'%').attr('aria-valuenow', (score.incorrect/score.max_questions*100));

    /* Check for End of Quiz */
    var remaining_questions = JSON.parse(localStorage.getItem(unit_id + "_question_ids")).length;
    if (remaining_questions == 0 ) {
      displayScore();
      document.querySelector("#question_text_wrapper").remove();
      document.querySelector("#hint_wrapper").remove();
      document.querySelector("#choice_menu_wrapper").remove();
    }


    return score;
  }


  function displayScore() {
    var score = JSON.parse(localStorage.getItem("{{unit_id}}"));
    $('#score_graph').fadeIn().removeClass('fade').css('display', 'block');
    $('#score_graph_options').fadeIn().removeClass('fade').css('display', 'block');
    var incorrect_count = 0;
    var correct_count   = 0;
    for (i = 0; i < score.length; i++ ) {
      if ( score[i] == "correct" ) {
        correct_count++;
      } else {
        incorrect_count++;
      }
    }
    var final_score = correct_count/(incorrect_count+correct_count);
    if ( final_score >= 0.8 ) {
      window.scrollTo(0,0);
      $('#results').html('<br><div class="alert alert-success"><b>Hey, good work there!<b> Your score is: <b>'+Math.floor(final_score*100)+'%</b></div>');
      for (var i = 0; i < 250; i++) {
        create(i);
      }
    } else {
      window.scrollTo(0,0);
      $('#results').html('<br><div class="alert alert-danger"><b>Better luck next time</b> - keep trying! You can do it! Your score is: <b>'+Math.floor(final_score*100)+'%</b></div>');
    }
    myChart.data.datasets[0].data[1] = correct_count;
    myChart.data.datasets[0].data[0] = incorrect_count;
    myChart.update();
  }

  Array.prototype.randomElement = function () {
      return this[Math.floor(Math.random() * this.length)]
  }

  Array.prototype.remove = function() {
      var what, a = arguments, L = a.length, ax;
      while (L && this.length) {
          what = a[--L];
          while ((ax = this.indexOf(what)) !== -1) {
              this.splice(ax, 1);
          }
      }
      return this;
  };


  var question_ids        = JSON.parse("{{question_ids}}");

  var prev_question_id = 0;
  var current_question_id = 0;
  var selected_choice = 0;

  var unit_id = "{{unit_id}}";
  var form_id = "{{form_id}}";
  var form_id = "{{form_id}}";
  var csrf    = "{{csrf_token}}";

  localStorage.setItem(unit_id + "_question_ids",JSON.stringify(question_ids));

  var end_of_quiz = false;

  /* Warn user before reloading the quiz (and losing all progress!) */
  window.onbeforeunload = function ()
  {
     return "";
  };


  function submitReport() {
    var error_type = document.getElementById("error_type");
    var selected = Array.from(error_type.selectedOptions).map(v=>v.value);
    var error_description = document.getElementById("error_description").value;

    $.ajax({
      url : "/error/report",
      type : "POST",
      data : { 'csrfmiddlewaretoken': '{{csrf_token}}', id: current_question_id, module: 'quiz', categories: JSON.stringify(selected), description: error_description },
      success : function(response) {
        $('#error_report_modal').modal('toggle')
        alert('Error successfully reported! Thank you!')
      },
      error : function(xhr,errmsg,err) {
        alert('There was an error submitting this error report :(')
      }
    });
  }


  function shuffle(array) {
    var currentIndex = array.length, temporaryValue, randomIndex;

    // While there remain elements to shuffle...
    while (0 !== currentIndex) {

      // Pick a remaining element...
      randomIndex = Math.floor(Math.random() * currentIndex);
      currentIndex -= 1;

      // And swap it with the current element.
      temporaryValue = array[currentIndex];
      array[currentIndex] = array[randomIndex];
      array[randomIndex] = temporaryValue;
    }

    return array;
  }

  function grade_question() {
    var status = document.querySelector('input[name="choice"]:checked').is_correct;
    selected_choice = document.querySelector('input[name="choice"]:checked').closest('.quiz-choice-labels').innerText;


    selected_choice = selected_choice.replace(/(\r\n|\n|\r)/gm, "");
    selected_choice = selected_choice.trim();
    console.log(selected_choice);

    if ( status === true ) {
      current_score.push("correct");              
      localStorage.setItem(unit_id,JSON.stringify(current_score));
      calculateScore();
    } else {
      current_score.push("incorrect");              
      localStorage.setItem(unit_id,JSON.stringify(current_score));
      calculateScore();
      //$('#error_modal').modal('toggle')
      document.getElementById("error_modal_button").click();
    }


    get_next_question();
    
  }

  document.addEventListener("DOMContentLoaded", function(){
    // Handler when the DOM is fully loaded
    get_next_question();
  });

  function get_next_question() {
    var id = JSON.parse(localStorage.getItem(unit_id + "_question_ids")).randomElement();
    var current_question_id = id; /* This is for the error report modal */
    JSON.parse(localStorage.getItem(unit_id + "_question_ids")).remove(id);
    var id_list = JSON.parse(localStorage.getItem(unit_id + "_question_ids")).remove(id);
    localStorage.setItem(unit_id + "_question_ids", JSON.stringify(id_list));

    $.ajax({
      url : "/quiz/{{unit_id}}/form_"+form_id+"/",
      type : "POST",
      data : { 'csrfmiddlewaretoken': csrf, next_question_id : id, prev_question_id: prev_question_id, unit_id: unit_id, form_id: form_id },
      success : function(response) {

        console.log(response);


        /* Question Text Template */
        document.querySelector("#question_text_wrapper").innerHTML = '';

        var question_template  = document.querySelector("#question_text_template")

        var question_text_wrapper = document.querySelector("#question_text_wrapper")

        var clone = document.importNode(question_template.content, true)

        console.log(id_list.length, max_questions)
        

        clone.querySelector("#template_question_form").innerHTML  = 'Form ' + response.form_short_name + ' &nbsp&nbsp ' + response.task_item;
        clone.querySelector("#template_unit_name").innerHTML      = response.unit_name;
        clone.querySelector("#questionNumber").innerHTML          = max_questions - id_list.length;
        clone.querySelector("#template_question_max").innerHTML   = max_questions;
        clone.querySelector("#template_question_text").innerHTML  = response.next_question[0][1];
        prev_question_id = response.next_question[0][0];

        document.querySelector('#error_modal_message').innerHTML = '';
        document.querySelector('#error_modal_message').innerHTML += "<span style='color: red;'>Your answer was... <b> " + selected_choice + "</b></span><br><br>";
        document.querySelector('#error_modal_message').innerHTML += "<span style='color: green;'>The correct response was... <b> " + response.prev_correct_choice + "</b></span><br>";
        document.querySelector('#error_modal_message').innerHTML += response.next_question[0][2];
        question_text_wrapper.appendChild(clone)


        /* Hint Text Template */
        document.querySelector("#hint_wrapper").innerHTML = '';

        var hint_template  = document.querySelector("#hint_template")

        var hint_wrapper = document.querySelector("#hint_wrapper")

        var clone = document.importNode(hint_template.content, true)

        clone.querySelector("#hint_template_text").innerHTML = response.next_question[0][2]

        hint_wrapper.appendChild(clone)
        


        /* Choice Wrapper Template */
        document.querySelector("#choice_menu_wrapper").innerHTML = ''

        var choice_wrapper_template  = document.querySelector("#choice_text_template")

        var choice_menu_wrapper = document.querySelector("#choice_menu_wrapper")

        var clone = document.importNode(choice_wrapper_template.content, true)

        choices = response.choices;
        clone.querySelector("#choice_form").action = '/quiz/'+unit_id+'/form_'+form_id+'/grade_question/'
          
        clone.querySelector("#choices_wrapper").innerHTML = ''
        for (i = 0; i < choices.length; i++) {

          /* Choice Template */
          var choice_template  = document.querySelector("#choice_template")

          var choices_wrapper = clone.querySelector("#choices_wrapper")

          var choice_clone = document.importNode(choice_template.content, true)
          choice_clone.querySelector('#choice_template_text').innerHTML = response.choices[i][1]
          choice_clone.querySelector('#choice_template_input').is_correct = response.choices[i][2]

          choices_wrapper.appendChild(choice_clone)

        }


        choice_menu_wrapper.appendChild(clone)

      },
      error : function(xhr,errmsg,err) {

      }
    });
    highlightAnswers();
    window.scrollTo(0,0);
  }

  function create(i) {
    var width = Math.random() * 8;
    var height = width * 0.4;
    var colourIdx = Math.ceil(Math.random() * 3);
    var colour = "red";
    switch(colourIdx) {
      case 1:
        colour = "yellow";
        break;
      case 2:
        colour = "blue";
        break;
      default:
        colour = "red";
    }
    $('<div class="confetti-'+i+' '+colour+'"></div>').css({
      "width" : width+"px",
      "height" : height+"px",
      "top" : -Math.random()*20+"%",
      "left" : Math.random()*100+"%",
      "opacity" : Math.random()+0.5,
      "transform" : "rotate("+Math.random()*360+"deg)"
    }).appendTo('.confetti_wrapper');  
    
    drop(i);
  }

  function drop(x) {
    $('.confetti-'+x).animate({
      top: "100%",
      left: "+="+Math.random()*15+"%"
    }, Math.random()*3000 + 3000, function() {
      reset(x);
    });
  }

  function reset(x) {
    $('.confetti-'+x).animate({
      "top" : -Math.random()*20+"%",
      "left" : "-="+Math.random()*15+"%"
    }, 0, function() {
      drop(x);             
    });
  }

</script>

{% endblock %}
