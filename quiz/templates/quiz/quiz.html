{% extends 'base.html' %}

{% block quiz-content %}

<div class="progress">
  <div id="progress_bar_correct" class="progress-bar bg-success" role="progressbar" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100"></div>
  <div id="progress_bar_incorrect" class="progress-bar bg-danger" role="progressbar" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100"></div>
</div>

  <!-- Displays the Quiz Results at the end !-->
  <div id="results"></div>
    <div  id="question_text">
      <p>Question #<span id="questionNumber">1 </span> of {{ total_questions }} â€” {{ unit_name }} Practice Quiz</p>

      <h6 style="font-size: 1.5rem;font-weight: normal"style="margin-top: 5px;">
        {{ question.question_text|safe }}
      </h6>
    </div>
  <br>
  <div id="score_graph" class="fade" style="display: none; height: 100%; width: 100%;max-height: 400px; max-width: 400px;margin: 0 auto 0 auto;">
    <canvas id="myChart" width="400" height="400"></canvas>
  </div>
  <div id="choice_menu" class="panel panel-primary">
    <div class="panel-heading">
      <h5 style="font-size: 1rem;font-weight: normal" class="panel-title">Select the best answer from these choices:</h5>
    </div>
    <div class="panel-body">
      <form action="/quiz/{{ unit_id }}/grade_question/" method="POST" id="post-form">
      {% csrf_token %}
      <div id="choices">
      {% for choice in question.choice_set.all %}
          <div>
            <label class="quiz-choice-labels">
              <input type="radio" name="choice" id="{{ choice.id }}" value="{{ choice.id }}" />
              <span class="quiz-choice-labels" style="font-weight: normal">{{ choice.choice_text }}</span>
            </label><br />
          </div>
      {% endfor %}
      </div>
    </div>
    <div class="panel-footer">
      <div class="btn-group btn-group-justified" role="group" aria-label="...">
        <div class="btn-group" role="group">
          <button type="button" data-toggle="collapse" data-target="#hint" class="btn btn-default">Give me a hint!</button>
        </div>
        <div class="btn-group" role="group">
          <button type="submit" id="post-form" class="btn btn-info"><b>Submit Answer</b></button>
          </form>
        </div>
      </div>
    </div>
  </div>

  <div class="collapse" id="hint">
    <div style="margin: 25px;">
      <h3>Here's a hint:</h3>
      {{ question.question_hint|safe }}
    </div>
  </div>

  <br /><br />

  <br /><br />


  <div class="container" style="text-align: center;">
    <button type="button" data-toggle="collapse" href="#disqus_thread" class="btn btn-info">
      <i class="far fa-comment"></i>
      Toggle Comments
    </button>
  </div>

  <br /><br />

  <!-- Disqus Code !-->
  <div id="disqus_thread" class="col-12"></div>

  <script>

  /**
  *  RECOMMENDED CONFIGURATION VARIABLES: EDIT AND UNCOMMENT THE SECTION BELOW TO INSERT DYNAMIC VALUES FROM YOUR PLATFORM OR CMS.
  *  LEARN WHY DEFINING THESE VARIABLES IS IMPORTANT: https://disqus.com/admin/universalcode/#configuration-variables*/
  /*
  var disqus_config = function () {
  this.page.url = PAGE_URL;  // Replace PAGE_URL with your page's canonical URL variable
  this.page.identifier = PAGE_IDENTIFIER; // Replace PAGE_IDENTIFIER with your page's unique identifier variable
  };
  */
  (function() { // DON'T EDIT BELOW THIS LINE
  var d = document, s = d.createElement('script');
  s.src = 'https://https-aba-rocks.disqus.com/embed.js';
  s.setAttribute('data-timestamp', +new Date());
  (d.head || d.body).appendChild(s);
  })();
  </script>
  <noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>

  <div id="error_modal" class="modal fade bd-example-modal-lg" tabindex="-1" role="dialog" aria-labelledby="Question Hint" aria-hidden="true">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <div class="modal-header">
          <h4 class="modal-title alert alert-danger" style='width: 100%;'><b>Oops!</b> That answer was not correct</h4>
        </div>
        <div class="modal-body">
          <div id="error_modal_message">
          </div>
        </body>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-default" data-dismiss="modal">OK, I got it</button>
      </div>
    </div>
  </div>



<script>

  var dataset = [];

  var ctx = document.getElementById("myChart");
  var myChart = new Chart(ctx, {
      type: 'doughnut',
      data: {
          labels: ["Incorrect", "Correct"],
          datasets: [{
              label: 'Score Report',
              data: dataset,
              backgroundColor: [
                  'rgba(255, 99, 132, 0.2)',
                  'rgba(75, 192, 192, 0.2)',
              ],
              borderColor: [
                  'rgba(255,99,132,1)',
                  'rgba(75, 192, 192, 1)',
              ],
              borderWidth: 1
          }]
      },
      options: {
          scales: {
              yAxes: [{
                  ticks: {
                      beginAtZero:true
                  }
              }]
          }
      }
  });

  $('#post-form').on('submit', function(event){
      event.preventDefault();
      grade_question();
  });

  var csrftoken = jQuery("[name=csrfmiddlewaretoken]").val();

  function csrfSafeMethod(method) {
      return (/^(GET|HEAD|OPTIONS|TRACE)$/.test(method));
  }
  $.ajaxSetup({
      beforeSend: function(xhr, settings) {
          if (!csrfSafeMethod(settings.type) && !this.crossDomain) {
              xhr.setRequestHeader("X-CSRFToken", csrftoken);
          }
      }
  });

  var current_score = [];
  localStorage.setItem("{{unit_id}}",JSON.stringify(current_score));
  console.log("Unit ID: {{unit_id}}");

  var max_questions = Number("{{total_questions}}");
  console.log('Max questions: ', max_questions)

  function calculateScore() {
    var score = JSON.parse(localStorage.getItem("{{unit_id}}"));

    var incorrect_count = 0;
    var correct_count   = 0;
    for (i = 0; i < score.length; i++ ) {
      if ( score[i] == "correct" ) {
        correct_count++;
      } else {
        incorrect_count++;
      }
    }
    var total_score = correct_count/(incorrect_count+correct_count);

    var score = new Object();
    score.correct = correct_count;
    score.incorrect = incorrect_count;
    score.percent_correct = total_score;
    score.max_questions = Number(max_questions);

    $('#progress_bar_correct').css('width', (score.correct/score.max_questions*100)+'%').attr('aria-valuenow', (score.correct/score.max_questions*100));
    $('#progress_bar_incorrect').css('width', (score.incorrect/score.max_questions*100)+'%').attr('aria-valuenow', (score.incorrect/score.max_questions*100));

    return score;
  }

  function displayScore() {
    var score = JSON.parse(localStorage.getItem("{{unit_id}}"));
    $('#score_graph').fadeIn().removeClass('fade').css('display', 'block');
    var incorrect_count = 0;
    var correct_count   = 0;
    for (i = 0; i < score.length; i++ ) {
      if ( score[i] == "correct" ) {
        correct_count++;
      } else {
        incorrect_count++;
      }
    }
    var final_score = correct_count/(incorrect_count+correct_count);
    if ( final_score >= 0.8 ) {
      window.scrollTo(0,0);
      $('#results').html('<br><div class="alert alert-success"><b>Hey, good work there!<b> Your score is: <b>'+Math.floor(final_score*100)+'%</b></div>');
    } else {
      window.scrollTo(0,0);
      $('#results').html('<br><div class="alert alert-danger"><b>Better luck next time</b> - keep trying! You can do it! Your score is: <b>'+Math.floor(final_score*100)+'%</b></div>');
    }
    myChart.data.datasets[0].data[1] = correct_count;
    myChart.data.datasets[0].data[0] = incorrect_count;
    myChart.update();
  }

  Array.prototype.randomElement = function () {
      return this[Math.floor(Math.random() * this.length)]
  }

  Array.prototype.remove = function() {
      var what, a = arguments, L = a.length, ax;
      while (L && this.length) {
          what = a[--L];
          while ((ax = this.indexOf(what)) !== -1) {
              this.splice(ax, 1);
          }
      }
      return this;
  };


  var question_ids      = JSON.parse("{{question_ids}}");
  //console.log(question_ids);
  var first_question_id = JSON.parse("{{first_question_id}}");
  question_ids = question_ids.remove(first_question_id);
  //console.log('Remaining ids: ', question_ids);
  var unit_id = "{{unit_id}}";
  localStorage.setItem(unit_id + "_question_ids",JSON.stringify(question_ids));
  var end_of_quiz = false;


  function grade_question() {
      var choice_id  = $('input[name=choice]:checked').attr("id");
      var q   = $('#'+choice_id).next('span').text();

      if ( typeof(choice_id) !== 'undefined' ) {
        var current_score = JSON.parse(localStorage.getItem("{{unit_id}}"));
        var id = JSON.parse(localStorage.getItem(unit_id + "_question_ids")).randomElement();
        var id_list = JSON.parse(localStorage.getItem(unit_id + "_question_ids")).remove(id);
        //console.log(id_list, id);

        localStorage.setItem(unit_id + "_question_ids", JSON.stringify(id_list));

        if ( typeof(id) === "undefined" ) {
          end_of_quiz = true;
          console.log("End of Quiz: ", end_of_quiz);
        }


        $.ajax({
          url : "/quiz/{{unit_id}}/",
          type : "POST",
          data : { 'csrfmiddlewaretoken': '{{csrf_token}}', next_question_id : id, unit_id: unit_id, selected_choice : q, selected_choice_id : choice_id }, // data sent with the post request
          success : function(response) {
              $('#results').html('');
              $('#questionNumber').html(max_questions - id_list.length);

              if ( end_of_quiz == false ) { 
                $('#hint').collapse('hide').html("<br><h3>Here's a hint:</h3>" + response.question_hint);
              } else {
                $('#hint').html('');
              }

              if (response.is_correct == true && end_of_quiz == false) {              
              current_score.push("correct");              
              localStorage.setItem("{{unit_id}}",JSON.stringify(current_score));
              calculateScore();

              $('#choices').html('');
              for (var i = 0; i < response.next_question_choices.length; i++) {
                $('#choices').append(`
                    <label class="quiz-choice-labels">
                        <input type="radio" name="choice" id="`+response.next_question_choices[i].id+`" value="`+i+`" />
                        <span class="quiz-choice-labels" style="font-weight: normal">`+response.next_question_choices[i].choice+`</span>
                      </label><br />
                  `);
                }
                window.scrollTo(0,0);
                $('#results').html('<div class="alert alert-success" role="alert"><b>Well done!</b> You got the previous question correct.</div>');

                $('#question_text').html('<small>Question #<span id="questionNumber">'+(max_questions - id_list.length)+' of '+max_questions+' </span> - '+response.unit_name+' Practice Quiz<br></small>'+response.next_question_text);
              } else {
                if ( end_of_quiz == true && response.is_correct == true) {
                  current_score.push("correct");
                  localStorage.setItem("{{unit_id}}",JSON.stringify(current_score));
                  calculateScore();

                  $('#question_text').html("<b>That's it!</b> You finished the quiz.");
                  $('#choice_menu').fadeOut();
                  displayScore();
                } else {
                  current_score.push("incorrect");
                  localStorage.setItem("{{unit_id}}",JSON.stringify(current_score));
                  calculateScore();
                  $('#error_modal').modal('show');
                  $('#error_modal_message').html('');
                  $('#error_modal_message').append('<h3 style="margin: 5px;"><small>The question was...</small><br> <p style="margin: 10px 0 0 10px;">'+response.prev_question_was+'</p></h3>');
                  $('#error_modal_message').append('<h3 style="color:green;"><small>The correct answer was...</small><br><p style="padding: 10px;"><b>'+response.correct_choice_text+'</b></p></h3>');
                  $('#error_modal_message').append('<h3 style="color:red;"><small>Your answer was...</small><br><p style="padding: 10px;"><b>'+response.prev_question_choice+'</b></p></h3><br>');
                  $('#error_modal_message').append(response.prev_question_hint);
                  $('#choices').html('');

                  if ( end_of_quiz == true ) {
                    $('#question_text').html("<b>That's it!</b> You finished the quiz.");
                    $('#choice_menu').fadeOut();
                    calculateScore();
                    displayScore();
                  } else {
                    for (var i = 0; i < response.next_question_choices.length; i++) {
                      $('#choices').append(`
                          <label class="quiz-choice-labels">
                            <input type="radio" name="choice" id="`+response.next_question_choices[i].id+`" value="`+i+`" />
                            <span class="quiz-choice-labels" style="font-weight: normal">`+response.next_question_choices[i].choice+`</span>
                          </label><br />
                        `);
                    }


                    $('#question_text').html('<small>Question #<span id="questionNumber">'+(max_questions - id_list.length)+' of '+max_questions+' </span> - '+response.unit_name+' Practice Quiz<br></small>'+response.next_question_text);
                  }
                }
              }
          },

          error : function(xhr,errmsg,err) {
              window.scrollTo(0,0);
              $('#results').html("<div class='alert-box alert radius' style='width: 100%;' data-alert>Oops! We have encountered an error: <i>"+err+
                  "</i>. Try again, I guess? If the problem persists, email <a href='mailto:alex@behaviorist.tech'>Alex</a></div>");
              console.log(xhr.status + ": " + xhr.responseText);
          }
        });
      } else {
        window.scrollTo(0,0);
        $('#results').html('<div class="alert alert-warning" role="alert"><b>Did you forget to make a choice??<br/> <strong>You clicked submit without picking a choice!</submit></div>');
      }
  };

</script>

{% endblock %}
